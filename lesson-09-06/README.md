# 排他制御とロックの仕組み

## 排他制御とは

複数のトランザクションが同時に同じデータを更新しようとしたときに、データの一貫性や整合性を保つための制御機能。矛盾を防ぐために必要。

## ロックとは

データベース内のデータに対する読み書きを一時的に制限する仕組み。排他制御の基本となる手法。

## ロックの種類

### 専有ロック（Exclusive Lock）

- ロックをかけたトランザクション**のみ**がデータの読み書き可能
- 他のトランザクションは、ロックが解除されるまでアクセスできない
- **更新処理の際に使用される**

### 共有ロック（Shared Lock）

- ロックをかけたトランザクション**および他のトランザクション**が、**読み出しのみ可能**
- 複数のトランザクションが同時にロックをかけることができる（読み取り専用）

## ロックの両立性

- **共有ロック**同士であれば、複数のトランザクションが**同時に**ロックをかけることができる
- これにより、読み取り処理が並行して実行可能になる

## ロックの粒度（Granularity）

ロックをかける際の対象データの単位のこと。

### 粒度の例
- データベース単位
- テーブル単位
- レコード単位

### 粒度を小さくした場合（例：レコード単位）
- 他のトランザクションが使えるデータが多くなる
- **並行性が高まり、競合が起きにくくなる**
- 管理が複雑になり、**CPUやメモリへの負荷が大きくなる**

### 粒度を大きくした場合（例：テーブル単位、データベース単位）
- 他のトランザクションが使えるデータが少なくなる
- **競合が起きやすくなる**
- 管理が簡単になり、**CPUやメモリへの負荷が少なくなる**

## 競合とは？

**競合（きょうごう）**とは、  
複数のトランザクションが**同じデータに同時にアクセス・操作しようとすることによって発生する衝突や干渉**のこと。

競合が発生すると、データの整合性が失われる恐れがあるため、排他制御（ロック）によって防止する必要がある。
